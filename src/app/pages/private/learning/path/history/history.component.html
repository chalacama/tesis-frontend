<section class="history" (click)="closeMenus()">
  <!-- Skeleton inicial -->
  <ng-container *ngIf="loadingInitial(); else contentTpl">
    <div class="list">
      <div class="row skeleton" *ngFor="let i of [0,1,2,3,4]">
        <div class="thumb sk"></div>
        <div class="body">
          <div class="line sk w-60"></div>
          <div class="line sk w-40"></div>
          <div class="owner skline">
            <div class="avatar sk"></div>
            <div class="line sk w-30"></div>
          </div>
          <div class="bar sk"></div>
        </div>
        <div class="actions">
          <div class="btn sk"></div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Contenido -->
  <ng-template #contentTpl>
    <div class="list">
      <article class="row" *ngFor="let c of items()" (click)="$event.stopPropagation()">
        <!-- Miniatura / portada -->
        <div class="thumb">
          <ng-container *ngIf="c.miniature_url; else defaultCover">
            <img (click)="goToCourse(c)" [src]="c.miniature_url!" alt="miniatura" />
          </ng-container>
          <ng-template #defaultCover>
            <div class="cover">
              <img [src]="DEFAULT_COVER" alt="portada por defecto" />
              <div class="cover-title">
                <div class="kicker">Curso</div>
                <div class="title">'{{ c.title }}'</div>
              </div>
            </div>
          </ng-template>
          <div class="badge" *ngIf="c.certificate">ðŸŽ“</div>
        </div>

        <!-- Contenido -->
        <div class="body">
          <h3 class="title">{{ c.title }}</h3>
          <p class="created">Creado: {{ c.created_at | date:'mediumDate' }}</p>

          <div class="owner">
            <ng-container *ngIf="ownerAvatar(c.owner).url; else ownerIni">
              <img class="avatar" [src]="ownerAvatar(c.owner).url!" alt="owner" />
            </ng-container>
            <ng-template #ownerIni>
              <div class="avatar initials">{{ ownerAvatar(c.owner).initials }}</div>
            </ng-template>
            <span class="owner-name">{{ ownerDisplay(c.owner) }}</span>
            <span class="owner-username" *ngIf="c.owner.username">&nbsp;{{ '@'+ c.owner.username }}</span>
          </div>

          <div class="progress">
            <div class="bar"><div class="fill" [style.width.%]="c.completion_percent"></div></div>
            <span class="pct">{{ c.completion_percent }}%</span>
          </div>

          <div class="meta">
            <ng-container *ngIf="c.certificate; else nocert">
              <div class="cert">CÃ³digo: {{ c.certificate.code }} â€¢ {{ c.certificate.created_at | date:'medium' }}</div>
            </ng-container>
            <ng-template #nocert>
              <!-- <div class="cert none">Sin certificado</div> -->
            </ng-template>

            <div *ngIf="type() === 'historial' && $any(c)['last_chapter']">
              Ãšltimo capÃ­tulo: {{ $any(c)['last_chapter']?.title }} Â· {{ $any(c)['last_seen_at'] | date:'short' }}
            </div>

            <div *ngIf="type() === 'guardados' && $any(c)['saved_updated_at']">
              Guardado: {{ $any(c)['saved_updated_at'] | date:'short' }}
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div *ngIf="c.certificate" class="actions">
          <button  class="icon-btn" type="button" (click)="toggleMenu(c.id, $event)" aria-label="MÃ¡s opciones">
            <ui-icon [size]="'sm'" [svgPath]="'svg/more-column.svg'"></ui-icon>
          </button>

          <!-- MenÃº flotante -->
          <div class="menu" *ngIf="openMenuId() === c.id">
            <button class="menu-item" type="button" [disabled]="!c.certificate" (click)="previewCertificate(c.certificate.code)">
              Previsualizar certificado
            </button>
            <button class="menu-item" type="button" [disabled]="!c.certificate" (click)="downloadCertificate(c.certificate.code)">
              Descargar certificado
            </button>
            <div class="menu-tip"></div>
          </div>
        </div>
      </article>
    </div>

    <!-- Loader al paginar -->
    <div class="more" *ngIf="loadingMore()">
      <div class="dot sk"></div><div class="dot sk"></div><div class="dot sk"></div>
    </div>

    <!-- Sentinel para IO -->
    <div #sentinel class="sentinel"></div>

    <!-- Fin -->
    <div class="end" *ngIf="!loadingMore() && !nextPageUrl && items().length > 0">
      No hay mÃ¡s cursos
    </div>
    <div class="empty" *ngIf="!loadingInitial() && items().length === 0">
      No hay elementos para mostrar.
    </div>
  </ng-template>
</section>
