<ui-loading-bar
  [visible]="save"
  [mask]="{ type: 'dimmed' }"
></ui-loading-bar>

<div class="stepper-edu stepper-edu-container">

  <!-- Encabezado -->
  <header class="stepper-edu-header">
    <h1>Información educativa</h1>
    <p>
      Registra tu sede, nivel educativo y carrera para completar este paso.
    </p>
  </header>

  <!-- Error general -->
  <div class="stepper-edu-error" *ngIf="submitError">
    {{ submitError }}
  </div>

  <!-- SKELETON -->
  <ng-container *ngIf="loading; else contentTpl">
    <div class="info-skeleton-card" *ngFor="let r of skeletonRows">
      <div class="skeleton-header skeleton-box"></div>
      <div class="skeleton-row">
        <div class="skeleton-box"></div>
        <div class="skeleton-box"></div>
      </div>
    </div>
  </ng-container>

  <ng-template #contentTpl>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="stepper-edu-form">

      <!-- Sede -->
      <div class="form-row">
        <label class="form-label" for="sede">
          Sede / Unidad educativa <span class="required">*</span>
        </label>

        <select
          id="sede"
          class="form-control"
          formControlName="sede_id"
          (change)="onChangeSede($any($event.target).value)"
        >
          <option [ngValue]="null">Selecciona una sede</option>
          <option *ngFor="let sede of sedes" [value]="sede.id">
            {{ sede.educational_unit?.name || 'Unidad sin nombre' }}
            -
            {{ sede.province_name || 'Provincia' }}
            /
            {{ sede.canton_name || 'Cantón' }}
          </option>
        </select>

        <div class="error" *ngIf="hasError('sede_id', 'required')">
          La sede es obligatoria.
        </div>
      </div>

      <!-- Info extra sede -->
      <div class="form-row hint" *ngIf="selectedSede?.educational_unit">
        Unidad seleccionada:
        <strong>{{ selectedSede?.educational_unit?.name }}</strong>
      </div>

      <!-- Carrera (solo si la sede tiene carreras) -->
      <div class="form-row" *ngIf="availableCareers.length > 0">
        <label class="form-label" for="career">
          Carrera (opcional)
        </label>

        <select
          id="career"
          class="form-control"
          formControlName="career_id"
          (change)="onChangeCareer($any($event.target).value)"
        >
          <option [ngValue]="null">Sin carrera</option>
          <option *ngFor="let career of availableCareers" [value]="career.id">
            {{ career.name }} (máx. {{ career.max_semesters }} niveles)
          </option>
        </select>
      </div>

      <div class="form-row" *ngIf="selectedSede && availableCareers.length === 0">
        <span class="hint">
          Esta sede no tiene carreras registradas.
        </span>
      </div>

      <!-- Nivel educativo -->
      <div class="form-row">
        <label class="form-label" for="educational_level">
          Nivel educativo <span class="required">*</span>
        </label>

        <select
          id="educational_level"
          class="form-control"
          formControlName="educational_level_id"
          (change)="onChangeEducationalLevel($any($event.target).value)"
        >
          <option [ngValue]="null">Selecciona un nivel educativo</option>
          <option
            *ngFor="let level of availableEducationalLevels"
            [value]="level.id"
          >
            {{ level.name }}
            <ng-container *ngIf="level.max_periods && level.max_periods > 0">
              (máx. {{ level.max_periods }} niveles)
            </ng-container>
          </option>
        </select>

        <div class="error" *ngIf="hasError('educational_level_id', 'required')">
          El nivel educativo es obligatorio.
        </div>
      </div>

      <!-- Nivel actual (solo si hay maxLevelAllowed) -->
      <div class="form-row" *ngIf="maxLevelAllowed">
        <label class="form-label" for="level">
          Nivel actual <span class="required">*</span>
        </label>

        <input
          id="level"
          type="number"
          class="form-control"
          formControlName="level"
          [min]="1"
          [max]="maxLevelAllowed || 1"
          placeholder="Ej: 1, 2, 3..."
        />

        <div class="hint">
          Debe estar entre <strong>1</strong> y
          <strong>{{ maxLevelAllowed }}</strong>.
          <span *ngIf="currentEducationalLevel?.period">
            ({{ currentEducationalLevel?.period }})
          </span>
        </div>

        <div class="error" *ngIf="hasError('level', 'required')">
          El nivel es obligatorio.
        </div>
        <div class="error" *ngIf="hasError('level', 'min')">
          El nivel mínimo permitido es 1.
        </div>
        <div class="error" *ngIf="hasError('level', 'max')">
          El nivel máximo permitido es {{ maxLevelAllowed }}.
        </div>
      </div>

      <!-- Botón continuar -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          Continuar
        </button>
      </div>
    </form>

  </ng-template>
</div>
