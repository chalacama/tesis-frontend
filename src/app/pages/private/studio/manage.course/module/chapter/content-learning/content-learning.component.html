<div class="cl-wrapper" [class.loading]="loading()">
  <div class="cl-header">
    <small class="muted">
      Elige si enlazas un <b>video de YouTube</b> o subes un <b>archivo</b>.
    </small>
  </div>

  <!-- Selector binario (YouTube | Archivo) -->
  <div class="switcher" role="tablist" aria-label="Tipo de contenido">
    <button
      type="button"
      class="switcher-btn"
      [class.active]="isYouTube()"
      (click)="pickYouTube()"
      [attr.aria-pressed]="isYouTube()"
    >
      <span class="icon">
        <ui-icon [size]="'sm'" [severity]="'primary'" [svgPath]="'svg/youtube.svg'"></ui-icon>
      </span>
      <span>YouTube</span>
    </button>

    <button
      type="button"
      class="switcher-btn"
      [class.active]="isArchivo()"
      (click)="pickArchivo()"
      [attr.aria-pressed]="isArchivo()"
    >
      <span class="icon">
        <ui-icon [size]="'sm'" [severity]="'primary'" [svgPath]="'svg/file.svg'"></ui-icon>
      </span>
      <span>Archivo</span>
    </button>
  </div>

  <!-- Panel YouTube -->
  <div class="panel" *ngIf="isYouTube()">
    <label class="lbl" for="yt-url">Pega la URL de YouTube</label>
    <input
      id="yt-url"
      type="text"
      class="input"
      [class.invalid]="form.controls.url.touched && form.controls.url.invalid"
      placeholder="Busca en YouTube o pega la URL de YouTube"
      [formControl]="form.controls.url"
      autocomplete="off"
      spellcheck="false"
    />
    <div class="error" *ngIf="form.controls.url.touched && form.controls.url.hasError('youtubeUrl')">
      Ingresa una URL válida de YouTube.
    </div>

    <div class="preview" *ngIf="isYouTube() && embedSafe()">
      <iframe
        class="preview-iframe"
        [src]="embedSafe()"
        title="YouTube video"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen>
      </iframe>
    </div>
  </div>

  <!-- Panel Archivo -->
  <div class="panel panel-file" *ngIf="isArchivo()">
    <div class="uploader" [formGroup]="form">

      <!-- Zona de arrastrar / soltar + clic -->
      <div
        class="dropzone"
        [class.drag-over]="dragOver()"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        (click)="openFileDialog(fileInput)"
      >
        <div class="dropzone-inner">
          <ui-icon
            [size]="'sm'"
            [severity]="'primary'"
            [svgPath]="'svg/file.svg'">
          </ui-icon>

          <div class="dropzone-text">
            <p class="dropzone-title">Suelta un archivo aquí o haz clic para seleccionarlo</p>
            <p class="dropzone-subtitle">
              Se permite un solo archivo. Tamaño máximo {{ MAX_FILE_MB }} MB.
            </p>
            <p class="dropzone-subtitle">
              Para videos: mínimo {{ MIN_VIDEO_SECONDS }} s y máximo {{ MAX_VIDEO_SECONDS }} s.
            </p>
          </div>
        </div>

        <input
          #fileInput
          type="file"
          class="dropzone-input"
          (change)="onFileInputChange($event)"
        />
      </div>

      <div class="error" *ngIf="fileError()">
        {{ fileError() }}
      </div>

      <!-- Vista previa tipo Classroom -->
      <div class="file-card" *ngIf="filePreviewType() && filePreviewUrl()">
        <div class="file-card-header">
          <div class="file-card-main">
            <ui-icon
              [size]="'sm'"
              [severity]="'primary'"
              [svgPath]="'svg/file.svg'">
            </ui-icon>

            <div class="file-card-info">
              <div class="file-name" [title]="fileName() || ''">
                {{ fileName() || 'Archivo adjunto' }}
              </div>
              <div class="file-meta" *ngIf="fileSizeLabel()">
                {{ fileSizeLabel() }}
              </div>
            </div>
          </div>

          <div class="file-card-actions">
            <button type="button" class="icon-btn" (click)="clearFile()">
              <ui-icon
                [size]="'sm'"
                [severity]="'primary'"
                [svgPath]="'svg/delete.svg'">
              </ui-icon>
            </button>
          </div>
        </div>

        <div class="file-card-body" [ngSwitch]="filePreviewType()">
          <figure *ngSwitchCase="'image'" class="file-preview-img">
            <img [src]="filePreviewUrl()!" alt="Vista previa de la imagen" />
          </figure>

          <div *ngSwitchCase="'video'" class="file-preview-media">
            <video [src]="filePreviewUrl()!" controls></video>
          </div>

          <div *ngSwitchCase="'audio'" class="file-preview-media">
            <audio [src]="filePreviewUrl()!" controls></audio>
          </div>

          <div *ngSwitchCase="'pdf'" class="file-preview-pdf">
            <iframe
              *ngIf="fileSafePreviewUrl()"
              [src]="fileSafePreviewUrl()!"
              title="Vista previa de PDF">
            </iframe>
          </div>

          <div *ngSwitchDefault class="file-preview-generic">
            <p>Vista previa no disponible para este tipo de archivo.</p>
            <a *ngIf="filePreviewUrl()" [href]="filePreviewUrl()!" target="_blank" rel="noopener">
              Abrir archivo en una nueva pestaña
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Acciones -->
  <div class="actions">
    <ui-button
      [disabled]="form.pristine"
      (click)="reset()"
      label="Restablecer"
      [icon]="{svgPath: 'svg/clear-all.svg'}"
      severity="secondary">
    </ui-button>

    <ui-button
      [disabled]="sabed || !!fileError()"
      (click)="save()"
      label="Guardar"
      [icon]="{svgPath: 'svg/save-outline.svg'}"
      severity="primary">
    </ui-button>
  </div>

</div>

<ui-loading-bar
  [visible]="loadbar()"
  [mask]="{ type: 'dimmed' }">
  Guardando cambios…
</ui-loading-bar>
