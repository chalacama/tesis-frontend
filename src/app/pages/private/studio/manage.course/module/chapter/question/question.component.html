<div class="test-wrapper" [class.loading]="loading()">

  <!-- Header -->
  <header class="test-header">
    <div class="left">
      <h3>Evaluación del capítulo</h3>
      <p class="muted" *ngIf="total() > 0">
        Preguntas: <b>{{ total() }}</b>
      </p>
    </div>

    <div class="actions">
      <ui-button label="Nueva pregunta" [icon]="{svgPath: 'svg/create.svg'}" severity="primary" (click)="addQuestion()">
      </ui-button>
      <!-- Collapse/Expand all -->
  <ui-button
    [icon]="{svgPath: 'svg/collapse-all.svg'}"
    severity="info"
    (click)="collapseAll()"
    label="Colapsar todo">
  </ui-button>

  <!-- Settings -->
  <ui-button
    (click)="showSetting()"
    [icon]="{svgPath: 'svg/config.svg'}"
    severity="info"
    label="Configuración">
  </ui-button>

      <ui-button [disabled]="form.pristine" (click)="reset()" label="Restablecer"
        [icon]="{svgPath: 'svg/clear-all.svg'}" severity="secondary">
      </ui-button>

      <ui-button [disabled]="form.valid === false || form.pristine" (click)="submit()" label="Guardar"
        [icon]="{svgPath: 'svg/save-outline.svg'}" severity="primary">
      </ui-button>
    </div>
  </header>

  <!-- Estados -->
  <section *ngIf="loading()" class="state">
    <div class="skeleton-card" *ngFor="let s of [1,2,3,4]"></div>
  </section>

  <section *ngIf="loadingError()" class="state error">
    {{ loadingError() }}
  </section>

  <!-- Formulario -->
  <form class="questions" [formGroup]="form">
    <div class="questions-list"
     formArrayName="questions"
     cdkDropList
     cdkDropListLockAxis="y"
     [cdkDropListData]="qArray.controls"
     (cdkDropListDropped)="dropQuestion($event)">
      <div class="question-card"
     *ngFor="let q of qArray.controls; index as i; trackBy: trackByControl"
     [formGroupName]="i"
     [class.submitted]="submitted()"
     [class.collapsed]="isCollapsed(i)"
     cdkDrag
     cdkDragLockAxis="y"
     (cdkDragStarted)="isDraggingQuestion.set(true)"
     (cdkDragEnded)="isDraggingQuestion.set(false)">


        <div class="q-drag" cdkDragHandle>
          <ui-icon [size]="'sm'" [severity]="'primary'" [svgPath]="'svg/drag-horizontal.svg'"></ui-icon>
        </div>
        <div class="q-head">
          <div class="badge" (click)="toggleCollapse(i)">
  <span>P{{ i + 1 }}</span>
  <span>
    <ui-icon class="chev" [class.expanded]="!isCollapsed(i)"
             [size]="'sm'" [severity]="'primary'" [svgPath]="'svg/arrow-right.svg'"></ui-icon>
  </span>
          </div>


          <!-- Enunciado editable -->
          <textarea class="statement-input" placeholder="Escribe el enunciado de la pregunta..."
            formControlName="statement" rows="2"></textarea>

          <!-- Selector de tipo -->
          <div class="type-chip">

            <select class="type-select" formControlName="type_questions_id"
              (change)="onTypeChange(i, $any($event.target).value)">
              <option class="type-option" *ngFor="let t of typeOptions()" [value]="t.id">
                <span class="type-label"> {{ t.nombre }}</span>

              </option>
            </select>
          </div>
          

        </div>

        <div class="q-body" [cdkDropListConnectedTo]="connectedTo(i)" [cdkDropListData]="answersArray(i).controls"
          [id]="listId(i)" cdkDropList (cdkDropListDropped)="dropAnswer($event)">

          <!-- Opciones -->
          <div class="option" *ngFor="let a of answersArray(i).controls; index as j; trackBy: trackByAnswerControl" cdkDrag
            [class.correct]="a.get('is_correct')!.value === true">

            <div class="option-label" [formGroup]="a">
              <span class="drag-handle" cdkDragHandle>
                <ui-icon [size]="'sm'" [severity]="'primary'" [svgPath]="'svg/drag.svg'"></ui-icon>
              </span>

              
              <ng-container *ngIf="!isMultiple(i); else multiBlock">
                
                <input type="radio" [checked]="singleCtrl(i).value === j" (change)="markCorrectSingle(i, j)" />
              </ng-container>

              <ng-template #multiBlock>
                <!-- MÚLTIPLE -->
                <ng-container *ngIf="isTypeRadioMulti(i); else checkboxTpl">
                  <!-- Múltiple CON apariencia de radio (usa checkbox para permitir varias) -->
                  <label class="fake-radio">
                    <input type="checkbox" class="visually-hidden" [checked]="a.get('is_correct')!.value === true"
                      (change)="toggleCorrectMulti(i, j, $any($event.target).checked)" />
                    <span class="radio-visual"></span>
                  </label>
                </ng-container>

                <!-- Múltiple con checkbox nativo (tipo 2) -->
                <ng-template #checkboxTpl>
                  <input type="checkbox" [checked]="a.get('is_correct')!.value === true"
                    (change)="toggleCorrectMulti(i, j, $any($event.target).checked)" />
                </ng-template>
              </ng-template>

              <!-- Texto de la opción editable -->
              <span class="letter">{{ letters(j) }}.</span>
              <input type="text" class="answer-input" formControlName="option"
                (focus)="onAnswerFocusSelectCorrect(i, j)" placeholder="Escribe la opción..." />
            </div>

            <!-- Acciones por opción -->
            <span class="option-actions">
              <ui-button [style]="{borderRadius: '50%', width: '35px', height: '35px' }" size="sm" variant="flat"
                (click)="duplicateAnswer(i, j)" [icon]="{svgPath: 'svg/duplicate.svg'}" severity="primary"></ui-button>

              <ui-button [style]="{borderRadius: '50%', width: '35px', height: '35px' }" size="sm" variant="flat"
                (click)="removeAnswer(i, j)" [icon]="{svgPath: 'svg/x.svg'}" severity="danger"></ui-button>
            </span>

            <!-- Plantilla MÚLTIPLE (checkbox) -->
            <ng-template #multipleTpl>
              <input type="checkbox" [checked]="a.get('is_correct')!.value === true"
                (change)="toggleCorrectMulti(i, j, $any($event.target).checked)" />
            </ng-template>

          </div>
        </div>

        <div class="q-footer">
          <ui-button label="Agregar respuesta" variant="flat" (click)="addAnswer(i)"
            [icon]="{svgPath: 'svg/create.svg'}">
          </ui-button>
          <div class="q-score">
            <label class="score-label" [attr.for]="'q-spot-' + i">Puntos</label>
            <input class="score-input" [id]="'q-spot-' + i" type="number" formControlName="spot" min="0" step="1"
              inputmode="numeric" pattern="[0-9]*" (change)="coerceSpot(i)" />
          </div>
          <div class="q-footer-actions">
            <ui-button [style]="{borderRadius: '50%', width: '40px', height: '40px'}" (click)="duplicateQuestion(i)"
              [icon]="{svgPath: 'svg/duplicate.svg'}">
            </ui-button>

            <ui-button [style]="{borderRadius: '50%', width: '40px', height: '40px' }" size="sm"
              (click)="removeQuestion(i)" [icon]="{svgPath: 'svg/delete.svg'}" severity="danger">
            </ui-button>
          </div>
        </div>
      </div>
    </div>
  </form>

</div>
<ui-loading-bar
  [visible]="saved()"
  [mask]="{ type: 'dimmed' }">
</ui-loading-bar>

<ui-dialog
  type="free"
  [variant]="'filled'"
  [closeOnMaskClick]="true"
  [(visible)]="dialogVisible"
>
  <form class="test-settings compact" [formGroup]="testForm" (ngSubmit)="saveSettingsFromDialog()">
    <header class="settings-head">
      <h3>Parámetros del test</h3>
      <p class="muted">Defina criterios de aplicación y de reporte para el instrumento.</p>
    </header>

    <div class="prefs" role="group" aria-labelledby="settings-title" id="settings-title">
      <!-- Orden aleatorio -->
      <div class="pref">
        <div class="pref-left">
          <span class="pref-term">Orden aleatorio</span>
          <small class="pref-def">Permuta la secuencia de reactivos en cada intento.</small>
        </div>
        <label class="toggle" title="Activa permutación por intento">
          <input type="checkbox" formControlName="random" aria-label="Orden aleatorio" />
          <span class="track"><span class="thumb"></span></span>
        </label>
      </div>

      <!-- Retroalimentación inmediata -->
      <div class="pref">
        <div class="pref-left">
          <span class="pref-term">Retroalimentación inmediata</span>
          <small class="pref-def">Muestra los ítems no acertados al enviar respuestas.</small>
        </div>
        <label class="toggle" title="Muestra preguntas incorrectas al responder">
          <input type="checkbox" formControlName="incorrect" aria-label="Retroalimentación inmediata" />
          <span class="track"><span class="thumb"></span></span>
        </label>
      </div>

      <!-- Informe de puntuación -->
      <div class="pref">
        <div class="pref-left">
          <span class="pref-term">Informe de puntuación</span>
          <small class="pref-def">Exhibe la calificación global al finalizar el intento.</small>
        </div>
        <label class="toggle" title="Mostrar puntuación total">
          <input type="checkbox" formControlName="score" aria-label="Informe de puntuación" />
          <span class="track"><span class="thumb"></span></span>
        </label>
      </div>

      <!-- Split -->
      <div class="pref">
        <div class="pref-left">
          <label for="split" class="pref-term">Muestreo de ítems (k)</label>
          <small class="pref-def">Divide el banco en <em>k</em> bloques iguales. 1 = todo el banco; 2 = 50% por intento.</small>
        </div>
        <input
          id="split"
          class="num"
          type="number"
          min="1"
          max="2"
          step="1"
          formControlName="split"
          (change)="coerceSplit()"
          aria-describedby="split-help"
          title="1..2 (enteros)"
        />
      </div>

      <!-- Intentos -->
      <div class="pref">
        <div class="pref-left">
          <label for="limited" class="pref-term">Intentos permitidos</label>
          <small id="split-help" class="pref-def">0 = sin límite; 1..2 = tope de intentos por estudiante.</small>
        </div>
        <input
          id="limited"
          class="num"
          type="number"
          min="0"
          max="2"
          step="1"
          formControlName="limited"
          (change)="coerceLimited()"
          title="0..2 (enteros)"
        />
      </div>
    </div>

    <footer class="settings-actions">
      <ui-button type="button" severity="secondary" (click)="dialogVisible = false" label="Cancelar"></ui-button>
      <ui-button type="submit" severity="primary" [icon]="{svgPath:'svg/save-outline.svg'}" label="Guardar"></ui-button>
    </footer>
  </form>
</ui-dialog>
