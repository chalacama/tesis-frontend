<!-- Barra de carga global (acciones de guardar/eliminar) -->
<ui-loading-bar
  [visible]="save"
  [mask]="{ type: 'dimmed' }"
></ui-loading-bar>

<!-- Toast global -->
<ui-toast></ui-toast>

<div class="category-page">
  <!-- Header -->
  <header class="category-header">
    <div class="header-text">
      <h2>Categorías</h2>
      <p class="subtitle">
        Gestiona las categorías que se usan en tus cursos.
      </p>
    </div>

    <button
      class="btn-primary"
      type="button"
      (click)="openCreateDialog()"
    >
      <ui-icon
        [size]="'sm'"
        [severity]="'primary'"
        [svgPath]="'svg/create.svg'">
      </ui-icon>
      <span class="btn-label">Nueva categoría</span>
    </button>
  </header>

  <!-- Toolbar (Búsqueda) -->
  <section class="category-toolbar">
    <div class="search-wrapper">
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por nombre de categoría..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilter()"
      />
    </div>
  </section>

  <!-- Tabla de categorías -->
  <section class="category-table-wrapper">
    <!-- Skeleton de carga -->
    <ng-container *ngIf="loading; else tableContent">
      <div class="skeleton-card" *ngFor="let row of skeletonRows">
        <div class="skeleton-line w-40"></div>
        <div class="skeleton-line w-20"></div>
      </div>
    </ng-container>

    <!-- Contenido real -->
    <ng-template #tableContent>
      <ng-container *ngIf="categories.length; else emptyState">
        <table class="category-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th class="th-number">Cursos</th>
              <th class="th-number">Usuarios interesados</th>
              <th class="th-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cat of categories">
              <td>
                <span class="cat-name">{{ cat.name }}</span>
              </td>
              <td class="td-number">
                {{ cat.courses_count }}
              </td>
              <td class="td-number">
                {{ cat.users_interested_count }}
              </td>
              <td class="td-actions">
                <button
                  type="button"
                  class="icon-btn"
                  (click)="openRenameDialog(cat)"
                  title="Renombrar categoría"
                >
                  <ui-icon
                    [size]="'sm'"
                    [severity]="'primary'"
                    [svgPath]="'svg/rename.svg'">
                  </ui-icon>
                </button>

                <button
                  type="button"
                  class="icon-btn danger"
                  (click)="openDeleteDialog(cat)"
                  title="Eliminar categoría"
                >
                  <ui-icon
                    [size]="'sm'"
                    [severity]="'danger'"
                    [svgPath]="'svg/delete.svg'">
                  </ui-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Paginación basada en la API -->
        <div class="pagination-wrapper" *ngIf="meta">
          <div class="pagination-info">
            Mostrando
            <strong>{{ meta.from || 0 }}</strong> -
            <strong>{{ meta.to || 0 }}</strong>
            de
            <strong>{{ meta.total }}</strong> categorías
          </div>

          <div class="pagination-controls">
            <button
              type="button"
              class="btn-ghost btn-outline"
              (click)="goToPage(meta.current_page - 1)"
              [disabled]="meta.current_page <= 1 || loading"
            >
              Anterior
            </button>

            <span class="pagination-page">
              Página {{ meta.current_page }} de {{ meta.last_page }}
            </span>

            <button
              type="button"
              class="btn-ghost btn-outline"
              (click)="goToPage(meta.current_page + 1)"
              [disabled]="meta.current_page >= meta.last_page || loading"
            >
              Siguiente
            </button>
          </div>
        </div>
      </ng-container>

      <ng-template #emptyState>
        <div class="empty-state">
          <p>No se encontraron categorías.</p>
          <button
            type="button"
            class="btn-ghost"
            (click)="openCreateDialog()"
          >
            Crear la primera categoría
          </button>
        </div>
      </ng-template>
    </ng-template>
  </section>

  <!-- Diálogo Renombrar / Crear -->
  <div class="dialog-backdrop" *ngIf="renameDialogOpen">
    <div class="dialog">
      <h3 class="dialog-title">
        {{ editingCategory ? 'Renombrar categoría' : 'Nueva categoría' }}
      </h3>
      <p class="dialog-text">
        {{
          editingCategory
            ? 'Actualiza el nombre de la categoría.'
            : 'Ingresa el nombre de la nueva categoría.'
        }}
      </p>

      <div class="dialog-body">
        <label class="field-label" for="catName">Nombre</label>
        <input
          id="catName"
          type="text"
          class="dialog-input"
          [(ngModel)]="renameName"
          placeholder="Ej. Programación, Matemáticas..."
          (keyup.enter)="saveRename()"
        />
      </div>

      <div class="dialog-actions">
        <button
          type="button"
          class="btn-ghost"
          (click)="closeRenameDialog()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn-primary"
          (click)="saveRename()"
        >
          {{ editingCategory ? 'Guardar cambios' : 'Crear' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Diálogo Eliminar -->
  <div class="dialog-backdrop" *ngIf="deleteDialogOpen">
    <div class="dialog">
      <h3 class="dialog-title danger">
        Eliminar categoría
      </h3>
      <p class="dialog-text">
        ¿Estás seguro de eliminar la categoría
        <strong>{{ deletingCategory?.name }}</strong>?
        Esta acción no se puede deshacer.
      </p>

      <div class="dialog-actions">
        <button
          type="button"
          class="btn-ghost"
          (click)="closeDeleteDialog()"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn-danger"
          (click)="confirmDelete()"
        >
          Sí, eliminar
        </button>
      </div>
    </div>
  </div>
</div>
